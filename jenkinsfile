pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
    PATH = "${HOME}/.local/bin:$PATH"
  }

  stages {
    stage('Install AWS CLI and Upload to S3') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'aws-s3-access',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          sh '''
            echo "🔧 Installing AWS CLI in user space..."

            # Try to install pip if missing (in Jenkins AMIs pip3 is usually present)
            if ! command -v pip3 > /dev/null; then
              echo "❌ pip3 not found, please install it manually or use a pre-built Jenkins agent with pip3."
              exit 1
            fi

            # Install awscli if not already available
            if ! command -v aws > /dev/null; then
              pip3 install --upgrade --user awscli
            fi

            echo "🔁 Ensuring AWS CLI is in PATH"
            export PATH="$HOME/.local/bin:$PATH"

            echo "🧪 AWS CLI version:"
            aws --version || { echo "❌ AWS CLI install failed"; exit 1; }

            echo "☁️ Uploading raw data to S3..."
            aws s3 cp data/raw/ s3://rawbuckett1/ --recursive

            echo "☁️ Uploading processed data to S3..."
            aws s3 cp data/processed/ s3://finalbuckett3/ --recursive

            echo "✅ Upload completed."
          '''
        }
      }
    }
  }
}