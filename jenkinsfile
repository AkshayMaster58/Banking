pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-east-1'
  }

  stages {
    stage('Install AWS CLI and Upload to S3') {
      steps {
        withCredentials([
          usernamePassword(
            credentialsId: 'aws-s3-access',
            usernameVariable: 'AWS_ACCESS_KEY_ID',
            passwordVariable: 'AWS_SECRET_ACCESS_KEY'
          )
        ]) {
          sh '''
            echo "üîß Checking pip3 and installing AWS CLI if missing..."

            if ! command -v pip3 > /dev/null; then
              echo "‚ùå pip3 not found. Please install Python3 and pip3 on your Jenkins host."
              exit 1
            fi

            # Install awscli in user-space
            pip3 install --upgrade --user awscli

            # Locate where aws got installed (macOS places it under Library/Python)
            export PY_BIN=$(python3 -m site --user-base)/bin
            export PATH="$PY_BIN:$PATH"

            echo "üß™ Checking AWS CLI version..."
            aws --version || { echo "‚ùå AWS CLI not available in PATH"; exit 1; }

            echo "‚òÅÔ∏è Uploading raw data..."
            aws s3 cp data/raw/ s3://rawbuckett1/ --recursive

            echo "‚òÅÔ∏è Uploading processed data..."
            aws s3 cp data/processed/ s3://finalbuckett3/ --recursive

            echo "‚úÖ S3 upload complete."
          '''
        }
      }
    }
  }
}